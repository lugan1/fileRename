plugins {
    id 'java'
    id 'org.jetbrains.kotlin.jvm'
}

group = 'org.example'
version = project.findProperty("version") ?: "1.0.0"

repositories {
    mavenCentral()
}

dependencies {
    testImplementation platform('org.junit:junit-bom:5.10.0')
    testImplementation 'org.junit.jupiter:junit-jupiter'
    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk8"
}

test {
    useJUnitPlatform()
}

kotlin {
    jvmToolchain(19)
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1ï¸âƒ£ .exe ìƒì„± & .zip íŒ¨í‚¤ì§• (unchanged)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

tasks.register('packageExe', Exec) {
    group = 'distribution'
    description = 'jpackageë¡œ .exe ë¹Œë“œ'
    def jarName = "fileRename-${project.version}.jar"
    commandLine 'jpackage',
            '--type', 'app-image',
            '--input', 'build/libs',
            '--name', 'MyApp',
            '--main-jar', jarName,
            '--main-class', 'org.example.Main',
            '--dest', 'build/exe'
}

tasks.register('packageZipExe', Zip) {
    group = 'distribution'
    description = 'ì••ì¶•ëœ exe ë°°í¬íŒŒì¼(.zip)ì„ ìƒì„±í•©ë‹ˆë‹¤.'
    dependsOn 'packageExe'
    from file("build/exe/MyApp")
    destinationDirectory.set(file("build/zip"))
    archiveFileName.set("MyApp.zip")
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 2ï¸âƒ£ ë²„ì „ ì¦ê°€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

tasks.register('bumpVersion') {
    group = 'distribution'
    description = 'gradle.propertiesì˜ version ì„ patch ë ˆë²¨ë¡œ 1 ì¦ê°€ì‹œí‚µë‹ˆë‹¤.'
    doLast {
        def propsFile = file("gradle.properties")
        def props = new Properties()
        props.load(propsFile.newInputStream())

        def oldVersion = props.getProperty("version")
        def parts = oldVersion.tokenize('.').collect { it.toInteger() }
        def newVersion = "${parts[0]}.${parts[1]}.${parts[2] + 1}"

        println "ğŸ“¦ ë²„ì „ ì¦ê°€: ${oldVersion} â†’ ${newVersion}"
        props.setProperty("version", newVersion)
        props.store(propsFile.newWriter(), null)
    }
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 3ï¸âƒ£ CHANGELOG ê°±ì‹ 
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

tasks.register('updateChangelog') {
    group = 'documentation'
    description = 'CHANGELOG.md ì•ì— ìµœì‹  ì»¤ë°‹ ë¡œê·¸ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.'
    dependsOn 'bumpVersion'
    doLast {
        // bumpVersion ì—ì„œ ê°±ì‹ ëœ gradle.properties ì½ì–´ì˜¤ê¸°
        def props = new Properties()
        props.load(file("gradle.properties").newInputStream())
        def newVersion = props.getProperty("version")
        def tag = "v${newVersion}"
        def date = new Date().format("yyyy-MM-dd")

        // ì´ì „ íƒœê·¸
        def versionParts = newVersion.tokenize('.').collect { it.toInteger() }
        def prevTag = "v${versionParts[0]}.${versionParts[1]}.${versionParts[2] - 1}"

        // ì»¤ë°‹ ë¡œê·¸
        def logCmd = ["git", "log", "${prevTag}..HEAD", "--pretty=format:- %s"]
        def commitLog = logCmd.execute().text.trim()

        // CHANGELOG ì—…ë°ì´íŠ¸
        def changelog = file("CHANGELOG.md")
        def header = "## ${tag} - ${date}\n${commitLog}\n\n"
        changelog.text = header + (changelog.exists() ? changelog.text : "")
        println "ğŸ“ CHANGELOG.md ê°±ì‹  ì™„ë£Œ"
    }
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 4ï¸âƒ£ GitHub Release ì—…ë¡œë“œ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

tasks.register('uploadRelease', Exec) {
    group = 'distribution'
    description = 'GitHub CLIë¥¼ ì‚¬ìš©í•´ Releaseë¥¼ ìƒì„±Â·ì—…ë¡œë“œí•©ë‹ˆë‹¤.'
    dependsOn 'packageZipExe', 'updateChangelog'

    doFirst {
        // 1) ìµœì‹  ë²„ì „ ì½ì–´ì„œ Tag, Title, Zip ê²½ë¡œ ê³„ì‚°
        def props = new Properties()
        props.load(file("gradle.properties").newInputStream())
        def version = props.getProperty("version")
        def tag     = "v${version}"
        def zipPath = file("${project.rootDir}/build/zip/MyApp.zip").absolutePath
        def title   = "Release ${version}"

        // 2) OSë³„ gh ì»¤ë§¨ë“œ ë¦¬ìŠ¤íŠ¸ êµ¬ì„±
        def isWin = System.properties['os.name'].toLowerCase().contains('windows')
        def ghCmd = isWin
                ? ["C:\\Program Files\\GitHub CLI\\gh.exe", "release", "create", tag, zipPath, "--title", title, "--notes", "ìë™ ë¦´ë¦¬ì¦ˆ ì—…ë¡œë“œì…ë‹ˆë‹¤."]
                : ["gh", "release", "create", tag, zipPath, "--title", title, "--notes", "ìë™ ë¦´ë¦¬ì¦ˆ ì—…ë¡œë“œì…ë‹ˆë‹¤."]

        // 3) Exec ì„¤ì • ì¬í• ë‹¹
        commandLine = ghCmd
        environment "GITHUB_TOKEN", System.getenv("GITHUB_TOKEN")
    }
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 5ï¸âƒ£ ìµœì¢… ì›Œí¬í”Œë¡œìš° Task
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

tasks.register('releaseAll') {
    group = 'distribution'
    description = '1) íŒ¨í‚¤ì§• â†’ 2) ë²„ì „ bump â†’ 3) CHANGELOG ê°±ì‹  â†’ 4) GitHub ë¦´ë¦¬ì¦ˆ'
    dependsOn 'uploadRelease'
}
