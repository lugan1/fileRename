plugins {
    id 'java'
    id 'org.jetbrains.kotlin.jvm'
}

group = 'org.example'
version = project.findProperty("version") ?: "1.0.0"

repositories {
    mavenCentral()
}

dependencies {
    testImplementation platform('org.junit:junit-bom:5.10.0')
    testImplementation 'org.junit.jupiter:junit-jupiter'
    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk8"
}

test {
    useJUnitPlatform()
}
kotlin {
    jvmToolchain(19)
}


// ğŸ”§ .exe ìƒì„± task
tasks.register('packageExe', Exec) {
    group = 'distribution'
    description = 'jpackageë¡œ .exe ë¹Œë“œ'

    def jarName = "fileRename-${project.version}.jar"

    commandLine 'jpackage',
            '--type', 'app-image',
            '--input', 'build/libs',
            '--name', 'MyApp',
            '--main-jar', jarName,
            '--main-class', 'org.example.Main',
            '--dest', 'build/exe'
}


// ğŸ“¦ .zip ìë™ ì••ì¶• task

tasks.register('packageZipExe', Zip) {
    group = 'distribution'
    description = 'ì••ì¶•ëœ exe ë°°í¬íŒŒì¼(.zip)ì„ ìƒì„±í•©ë‹ˆë‹¤.'

    dependsOn 'packageExe' // .exe ë¨¼ì € ìƒì„±

    def exeAppName = 'MyApp'
    def sourceDir = file("build/exe/${exeAppName}")
    def outputDir = file("build/zip")

    from sourceDir
    destinationDirectory.set(outputDir)
    archiveFileName.set("${exeAppName}.zip")
}

tasks.register('releaseAll') {
    group = 'distribution'
    description = 'ìë™ìœ¼ë¡œ ë²„ì „ ì¦ê°€ + ë¹Œë“œ + zip + GitHub Release (OS ëŒ€ì‘, ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìë™ ìƒì„±)'

    dependsOn 'build'
    dependsOn 'packageZipExe'

    doLast {
        def propsFile = file("gradle.properties")
        def props = new Properties()
        props.load(propsFile.newInputStream())

        def oldVersion = props.getProperty("version")
        def parts = oldVersion.tokenize('.').collect { it.toInteger() }
        def newVersion = "${parts[0]}.${parts[1]}.${parts[2] + 1}"

        println "ğŸ“¦ ë²„ì „ ì¦ê°€: ${oldVersion} â†’ ${newVersion}"
        props.setProperty("version", newVersion)
        props.store(propsFile.newWriter(), null)

        def tag = "v${newVersion}"
        def zipPath = "build/zip/MyApp.zip"
        def title = "Release ${newVersion}"
        def date = new Date().format("yyyy-MM-dd")

        // ğŸ” ì´ì „ íƒœê·¸ ê¸°ì¤€ ì»¤ë°‹ ë¡œê·¸ ì¶”ì¶œ
        def previousTag = "v${parts[0]}.${parts[1]}.${parts[2]}"
        def logCmd = ["git", "log", "${previousTag}..HEAD", "--pretty=format:- %s"]
        def commitLog = logCmd.execute().text.trim()

        // ğŸ“ CHANGELOG.md ì•ì— ì¶”ê°€
        def changelog = file("CHANGELOG.md")
        def changelogEntry = """
## ${tag} - ${date}
${commitLog}

""" + (changelog.exists() ? changelog.text : "")
        changelog.text = changelogEntry
        println "ğŸ“ CHANGELOG.md ê°±ì‹  ì™„ë£Œ"

        // OS íŒë³„ í›„ gh ëª…ë ¹ ê²½ë¡œ ì„¤ì •
        def isWindows = System.properties['os.name'].toLowerCase().contains('windows')
        def ghCmd
        if (isWindows) {
            def ghPath = "C:\\Program Files\\GitHub CLI\\gh.exe"
            ghCmd = "\"${ghPath}\" release create ${tag} ${zipPath} --title \"${title}\" --notes \"ìë™ ë¦´ë¦¬ì¦ˆ ì—…ë¡œë“œì…ë‹ˆë‹¤.\""
        } else {
            ghCmd = "gh release create ${tag} ${zipPath} --title '${title}' --notes 'ìë™ ë¦´ë¦¬ì¦ˆ ì—…ë¡œë“œì…ë‹ˆë‹¤.'"
        }

        println "ğŸš€ GitHub Release ì—…ë¡œë“œ..."
        def proc = ghCmd.execute()
        proc.in.eachLine { println "[STDOUT] $it" }
        proc.err.eachLine { println "[STDERR] $it" }
        def exitCode = proc.waitFor()

        if (exitCode != 0) {
            throw new GradleException("âŒ GitHub Release ì‹¤íŒ¨: ì¢…ë£Œ ì½”ë“œ ${exitCode}")
        }

        println "âœ… ë¦´ë¦¬ì¦ˆ ì„±ê³µ: ${tag}"
    }
}
