// https://plugins.gradle.org/ ì—ì„œ í”ŒëŸ¬ê·¸ì¸ idë¥¼ ê²€ìƒ‰í•˜ê³  ìë™ ë‹¤ìš´ë°›ëŠ”ë‹¤.
// .gradle/ ì— ìºì‹œí•˜ê³  ë‹¤ìŒë¶€í„°ëŠ” ì—¬ê¸°ì„œ ë¡œë“œí•œë‹¤.
plugins {
    id 'java'
    id 'org.jetbrains.kotlin.jvm'
}

group = 'org.example'
version = project.findProperty("version") ?: "1.0.0"

repositories {
    mavenCentral()
}

dependencies {
    testImplementation platform('org.junit:junit-bom:5.10.0')
    testImplementation 'org.junit.jupiter:junit-jupiter'
    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk8"
}

test {
    useJUnitPlatform()
}

//id 'org.jetbrains.kotlin.jvm' í”ŒëŸ¬ê·¸ì¸ì´ í•„ìš”í•¨. jvmToolchain ì€ ì½”í‹€ë¦°ì„ ì»´íŒŒì¼í•  jdk ë²„ì „ì„ ì§€ì •í•œë‹¤.
kotlin {
    jvmToolchain(19)
}



//ìŠ¤í¬ë¦½íŠ¸ ëª…ë ¹ì–´ ì‹¤í–‰ë°©ë²•
//(1). ['git', 'status'].execute()
//Groovyì˜ ê¸°ë³¸ ê¸°ëŠ¥ì´ì•¼.
//execute()ëŠ” Javaì˜ Runtime.exec(...)ë¥¼ ê°ì‹¼ ê¸°ëŠ¥ì´ì•¼.
//ë¦¬í„´ê°’ì€ java.lang.Process
//ì¶œë ¥ ê²°ê³¼ë¥¼ result.text ë˜ëŠ” result.in.text ë“±ìœ¼ë¡œ ì–»ìŒ.
//ì˜ˆì™¸ ë°œìƒ ì‹œ ì§ì ‘ try-catch í•´ì•¼ í•¨.
//Gradle Taskì˜ ë¹Œë“œ ìºì‹œ, ì¶œë ¥ ì œì–´ ë“±ê³¼ëŠ” ë¬´ê´€.


//(2). exec{ commandLine 'git', 'status' }
//Gradle Task ë‚´ë¶€ì—ì„  exec {}ê°€ ë” ìì—°ìŠ¤ëŸ¬ì›€
//Gradleì˜ Project.exec {} ë˜ëŠ” Task ë‚´ë¶€ì˜ exec {} êµ¬ë¬¸ì—ì„œ ì‚¬ìš©.
//ë¦¬í„´ê°’ì€ ExecResult
//ignoreExitValue, standardOutput, environment, workingDir ë“±ì˜ ì œì–´ê°€ ë” í’ë¶€.
//ë¹Œë“œ íƒœìŠ¤í¬ë¡œ ì¸ì‹ë˜ë©°, Gradleì˜ ì˜ì¡´ì„± ê·¸ë˜í”„ ë° ìºì‹œì™€ í†µí•©ë¨.
//ì—ëŸ¬ ì‹œ ìë™ìœ¼ë¡œ ì˜ˆì™¸ë¥¼ ë˜ì§ (ì˜µì…˜ìœ¼ë¡œ ë¬´ì‹œ ê°€ëŠ¥)


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1ï¸âƒ£ .exe ìƒì„± & .zip íŒ¨í‚¤ì§• (unchanged)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// ìƒˆë¡œìš´ Taskë¥¼ ë“±ë¡: ì´ë¦„ì€ 'packageExe', íƒ€ì…ì€ Exec (ì™¸ë¶€ ëª…ë ¹ ì‹¤í–‰ìš©)
// Exec íƒ€ì…ì€ task ì‹¤í–‰ì‹œ commandLine ëª…ë ¹ì–´ê°€ ë°”ë¡œ ì‹¤í–‰ëœë‹¤. ë°˜ëŒ€ë¡œ exec { } ì€ í•´ë‹¹ ë¼ì¸ì— ë„ë‹¬í•´ì•¼ ëª…ë ¹ì–´ ì‹¤í–‰
tasks.register('packageExe', Exec) {

    // Gradle Task ê·¸ë£¹ ì´ë¦„ ì§€ì • (ì˜ˆ: gradlew tasks ë¡œ ë³¼ ë•Œ 'distribution' ì•„ë˜ì— í‘œì‹œë¨)
    group = 'distribution'

    // Taskì— ëŒ€í•œ ì„¤ëª… (gradlew tasks ì‹œ ì¶œë ¥ë¨)
    description = 'jpackageë¡œ .exe ë¹Œë“œ'

    // ì´ Taskë¥¼ ì‹¤í–‰í•˜ê¸° ì „ì— ë°˜ë“œì‹œ 'jar' Taskê°€ ë¨¼ì € ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •
    dependsOn 'jar'

    // ë¹Œë“œëœ JAR íŒŒì¼ ì´ë¦„ì„ ë™ì ìœ¼ë¡œ ìƒì„± (ì˜ˆ: fileRename-1.0.0.jar)
    def jarName = "fileRename-${project.version}.jar"

    // jpackage ëª…ë ¹ì–´ ì‹¤í–‰: ì•„ë˜ ì¸ìë“¤ì„ ìˆœì„œëŒ€ë¡œ ì „ë‹¬
    commandLine 'jpackage',
            '--type', 'app-image',           // ì•± ì´ë¯¸ì§€ë¥¼ ìƒì„± (ì‹¤í–‰ ê°€ëŠ¥í•œ ë””ë ‰í† ë¦¬ êµ¬ì¡°)
            '--input', 'build/libs',         // jar íŒŒì¼ì´ ìœ„ì¹˜í•œ ë””ë ‰í† ë¦¬ ì§€ì •
            '--name', 'MyApp',               // ìƒì„±ë  ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„ (ì˜ˆ: MyApp.exe)
            '--main-jar', jarName,           // ì‹¤í–‰í•  ë©”ì¸ JAR íŒŒì¼ ì§€ì •
            '--main-class', 'org.example.Main', // ì• í”Œë¦¬ì¼€ì´ì…˜ ì§„ì…ì  í´ë˜ìŠ¤ ì§€ì •
            '--dest', 'build/exe'            // ìƒì„± ê²°ê³¼ë¬¼ì„ ì €ì¥í•  ì¶œë ¥ ë””ë ‰í† ë¦¬
}


// 'packageZipExe'ë¼ëŠ” ì´ë¦„ì˜ Zip íƒ€ì… Task ë“±ë¡ (ì••ì¶• íŒŒì¼ ìƒì„±ìš©)
tasks.register('packageZipExe', Zip) {

    // Gradleì—ì„œ ì´ Taskê°€ ì†í•  ê·¸ë£¹ì„ ì§€ì • ('gradlew tasks' ëª…ë ¹ì–´ ì‹œ ë¶„ë¥˜ìš©)
    group = 'distribution'

    // Task ì„¤ëª…: ì´ Taskê°€ ë¬´ì—‡ì„ í•˜ëŠ”ì§€ ì„¤ëª… (ë¬¸ì„œí™” ë° ê°€ë…ì„± ëª©ì )
    description = 'ì••ì¶•ëœ exe ë°°í¬íŒŒì¼(.zip)ì„ ìƒì„±í•©ë‹ˆë‹¤.'

    // ì´ Taskë¥¼ ì‹¤í–‰í•˜ê¸° ì „ì— ë°˜ë“œì‹œ 'packageExe' Taskê°€ ë¨¼ì € ì‹¤í–‰ë˜ì–´ì•¼ í•¨
    dependsOn 'packageExe'

    // ì••ì¶•í•  ëŒ€ìƒ ë””ë ‰í† ë¦¬ ì§€ì •: packageExe ê²°ê³¼ë¬¼ì´ ìˆëŠ” í´ë”
    from file("build/exe/MyApp")

    // ìƒì„±ëœ zip íŒŒì¼ì´ ì €ì¥ë  ë””ë ‰í† ë¦¬ ì§€ì •
    destinationDirectory.set(file("build/zip"))

    // ìƒì„±ë  zip íŒŒì¼ ì´ë¦„ ì„¤ì •
    archiveFileName.set("MyApp.zip")
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 2ï¸âƒ£ ë²„ì „ ì¦ê°€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

tasks.register('bumpVersion') {
    group = 'distribution'
    description = 'gradle.propertiesì˜ version ì„ patch ë ˆë²¨ë¡œ 1 ì¦ê°€ì‹œí‚µë‹ˆë‹¤.'
    doLast {
        def propsFile = file("gradle.properties")
        def props = new Properties()
        props.load(propsFile.newInputStream())

        def oldVersion = props.getProperty("version")
        def parts = oldVersion.tokenize('.').collect { it.toInteger() }
        def newVersion = "${parts[0]}.${parts[1]}.${parts[2] + 1}"

        println "ğŸ“¦ ë²„ì „ ì¦ê°€: ${oldVersion} â†’ ${newVersion}"
        props.setProperty("version", newVersion)
        props.store(propsFile.newWriter(), null)
    }
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 3ï¸âƒ£ CHANGELOG ê°±ì‹ 
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

tasks.register('updateChangelog') {
    group = 'documentation'
    description = 'CHANGELOG.md ì•ì— ìµœì‹  ì»¤ë°‹ ë¡œê·¸ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.'
    dependsOn 'bumpVersion'
    doLast {
        // bumpVersion ì—ì„œ ê°±ì‹ ëœ gradle.properties ì½ì–´ì˜¤ê¸°
        def props = new Properties()
        props.load(file("gradle.properties").newInputStream())
        def newVersion = props.getProperty("version")
        def tag = "v${newVersion}"
        def date = new Date().format("yyyy-MM-dd")

        // ì´ì „ íƒœê·¸
        def versionParts = newVersion.tokenize('.').collect { it.toInteger() }
        def prevTag = "v${versionParts[0]}.${versionParts[1]}.${versionParts[2] - 1}"

        // ì»¤ë°‹ ë¡œê·¸
        def logCmd = ["git", "log", "${prevTag}..HEAD", "--pretty=format:- %s"]
        def commitLog = logCmd.execute().text.trim()

        // CHANGELOG ì—…ë°ì´íŠ¸
        def changelog = file("CHANGELOG.md")
        def header = "## ${tag} - ${date}\n${commitLog}\n\n"
        changelog.text = header + (changelog.exists() ? changelog.text : "")
        println "ğŸ“ CHANGELOG.md ê°±ì‹  ì™„ë£Œ"
    }
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 4ï¸âƒ£ GitHub Release ì—…ë¡œë“œ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

tasks.register('uploadRelease') {
    group = 'distribution'
    description = 'GitHub ë¦´ë¦¬ì¦ˆ ìƒì„± ë˜ëŠ” ìì‚° ì—…ë¡œë“œ'
    //dependsOn: ì´ Task ì‹¤í–‰ ì „ì— ë°˜ë“œì‹œ ì™„ë£Œë˜ì–´ì•¼ í•˜ëŠ” Taskë¥¼ ì§€ì •. ì˜ì¡´ ê´€ê³„ ì„¤ì •.
    dependsOn 'packageZipExe', 'updateChangelog'

    // â¶ í˜„ì¬ Git ë¸Œëœì¹˜ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    // def: Groovyì˜ ì§€ì—­ ë³€ìˆ˜ ì„ ì–¸ í‚¤ì›Œë“œ. íƒ€ì…ì„ ëª…ì‹œí•˜ì§€ ì•Šì•„ë„ ë¨.
    def currentBranch = 'unknown'

    /*
    ['git', ...].execute(): ì»¤ë§¨ë“œ ë¼ì¸ì„ ì‹¤í–‰í•˜ëŠ” Groovyì˜ ê¸°ëŠ¥. git ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•¨.
    .text: ëª…ë ¹ ê²°ê³¼ë¥¼ ë¬¸ìì—´ë¡œ ê°€ì ¸ì˜´.
    .trim(): ì–‘ìª½ ê³µë°± ì œê±°.
    try-catch: ì‹¤íŒ¨í•  ê²½ìš° ë¬´ì‹œí•˜ê³  ë„˜ì–´ê° (ì—ëŸ¬ ì•ˆì „ ì²˜ë¦¬).
    * */
    try {
        currentBranch = ['git', 'rev-parse', '--abbrev-ref', 'HEAD']
                .execute()
                .text
                .trim()
    } catch (ignored) {
    }

    // â· uploadRelease Taskì— ì¡°ê±´ ê±¸ê¸°
    // main ë˜ëŠ” release/ ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ë¸Œëœì¹˜ì¼ ë•Œë§Œ í™œì„±í™”
    enabled = (currentBranch == 'main' || currentBranch.startsWith('release/'))

    // (ì„ íƒ) ë¡œê·¸ í•œ ì¤„ ì¶”ê°€í•´ì„œ ë¡œì»¬ í…ŒìŠ¤íŠ¸í•  ë•Œ í™•ì¸í•˜ê¸°
    // doFirst {}: Task ì‹¤í–‰ ì „ì— ìˆ˜í–‰ë  ë¸”ë¡. ì´ˆê¸° ë¡œê·¸ ë˜ëŠ” ì¡°ê±´ í™•ì¸ì— ì‚¬ìš©.
    doFirst {
        println "â–¶ uploadRelease enabled? ${enabled} (currentBranch=${currentBranch})"
    }

    //doLast {}: Task ì‹¤í–‰ í›„ ì‹¤ì œ ë¡œì§ì´ ìˆ˜í–‰ë˜ëŠ” ë©”ì¸ ë¸”ë¡.
    doLast {
        // 1) ë²„ì „Â·íƒœê·¸Â·ê²½ë¡œÂ·ë©”ëª¨ ê³„ì‚°

        //new Properties(): ìë°”ì˜ Properties ê°ì²´. í‚¤-ê°’ ìŒì„ ë‹´ëŠ” ì„¤ì • íŒŒì¼ ë¡œë”©ì— ì‚¬ìš©.
        def props = new Properties()

        //.load(): InputStreamì—ì„œ .properties íŒŒì¼ì˜ í‚¤-ê°’ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜´.
        props.load(file("gradle.properties").newInputStream())
        def version = props.getProperty("version")
        def tag     = "v${version}"
        def zipPath = file("${project.rootDir}/build/zip/MyApp.zip").absolutePath
        def title   = "Release ${version}"
        def notes   = "ìë™ ë¦´ë¦¬ì¦ˆ ì—…ë¡œë“œì…ë‹ˆë‹¤."

        // 2) ê¸°ì¡´ ë¦´ë¦¬ì¦ˆ ì¡´ì¬ ì—¬ë¶€ í™•ì¸


        //exec {}: ì™¸ë¶€ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ëŠ” Gradle ë‚´ì¥ í•¨ìˆ˜. OS ì…¸ ëª…ë ¹ì„ ì‹¤í–‰í•  ë•Œ ì‚¬ìš©.
        //exec {} ì€ ExecResult íƒ€ì…ì„ ë¦¬í„´í•œë‹¤.
        // .exitValue()	í”„ë¡œì„¸ìŠ¤ì˜ ì¢…ë£Œ ì½”ë“œ. ì¼ë°˜ì ìœ¼ë¡œ 0ì´ë©´ ì„±ê³µ.
        // .assertNormalExitValue()	exit codeê°€ 0ì´ ì•„ë‹ˆë©´ ì˜ˆì™¸ë¥¼ ë˜ì§.
        // .rethrowFailure()	ì‹¤í–‰ ì¤‘ ë°œìƒí•œ ì—ëŸ¬ë¥¼ ë‹¤ì‹œ throw. (ì£¼ë¡œ ì»¤ìŠ¤í…€ ì²˜ë¦¬í•  ë•Œ ì‚¬ìš©)
        def view = exec {
            //commandLine: ì‹¤í–‰í•  ëª…ë ¹ì–´ì™€ ì¸ì. ì—¬ê¸°ì„œëŠ” GitHub CLI ì‚¬ìš©.
            commandLine 'gh', 'release', 'view', tag
            //ignoreExitValue = true: ëª…ë ¹ì–´ ì‹¤íŒ¨(ë¹„ì •ìƒ ì¢…ë£Œ) ì‹œì—ë„ ì—ëŸ¬ë¥¼ ë˜ì§€ì§€ ì•ŠìŒ.
            ignoreExitValue = true
            //standardOutput, errorOutput: ëª…ë ¹ì–´ ê²°ê³¼ë¥¼ ë©”ëª¨ë¦¬ë¡œ ì €ì¥.
            standardOutput = new ByteArrayOutputStream()
            errorOutput    = new ByteArrayOutputStream()
        }
        def exists = (view.exitValue == 0)

        println exists
                ? "â„¹ï¸ ë¦´ë¦¬ì¦ˆ ${tag}ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ìì‚°ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤."
                : "âœ¨ ìƒˆë¡œìš´ ë¦´ë¦¬ì¦ˆ ${tag} ìƒì„± ì¤‘..."

        // 3) ì‹¤ì œ ì—…ë¡œë“œ/ìƒì„±
        exec {
            commandLine exists
                    ? ['gh', 'release', 'upload', tag, zipPath, '--clobber']
                    : ['gh', 'release', 'create', tag, zipPath, '--title', title, '--notes', notes]

            //environment(...): ì‹¤í–‰ í™˜ê²½ ë³€ìˆ˜ ì§€ì •. ì—¬ê¸°ì„œëŠ” GITHUB_TOKENì„ í™˜ê²½ì— ì£¼ì…í•˜ì—¬ ì¸ì¦ ì²˜ë¦¬.
            //System.getenv(...): ì‹œìŠ¤í…œ í™˜ê²½ë³€ìˆ˜ì—ì„œ ê°’ì„ ì½ìŒ.
            environment "GITHUB_TOKEN", System.getenv("GITHUB_TOKEN")
        }
    }
}




// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 5ï¸âƒ£ ìµœì¢… ì›Œí¬í”Œë¡œìš° Task
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

tasks.register('releaseAll') {
    group = 'distribution'
    description = '1) íŒ¨í‚¤ì§• â†’ 2) ë²„ì „ bump â†’ 3) CHANGELOG ê°±ì‹  â†’ 4) GitHub ë¦´ë¦¬ì¦ˆ'
    dependsOn 'uploadRelease'
}
